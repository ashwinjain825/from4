<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
  <link rel="stylesheet" href="style/styleForApp.css">
  <link rel="icon" type="image/png" href="resources/from4_icon.png"/>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Know your From4</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map {
      height: 400px;
      width: 100%;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="header">
    <img src="resources/from4_landscape.png" alt="">
    <span class="material-symbols-outlined" onclick="location.href='index.html'">home</span>
  </div>

  <div class="content">
    <div class="content-menu">
      <div>
        <span class="material-symbols-outlined">location_on</span><br>
        Current
      </div>
      <div>
        <span class="material-symbols-outlined">search</span><br>
        Search
      </div>
      <div>
        <span class="material-symbols-outlined">qr_code_scanner</span><br>
        Decode
      </div>
      <div>
        <span class="material-symbols-outlined">bookmark</span><br>
        Saved
      </div>
    </div>

    <div class="content-main">
      <div class="content-info" id="current-location">
        Click the map or use the button below.
        <br>
        <button class="black-btn" onclick="fetchLocation()">Get Current Location</button>
      </div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script type="module">
    import { words } from './scripts/dict.js'; // must exist!

    // Base ranges
    const latRange = [2.5, 38.5];
    const longRange = [63.5, 99.5];
    const rows = 36, cols = 36;

    function getBlock(lat, long, currentLatRange, currentLongRange, r, c) {
      const latStep = (currentLatRange[1] - currentLatRange[0]) / r;
      const longStep = (currentLongRange[1] - currentLongRange[0]) / c;

      let row = Math.floor((lat - currentLatRange[0]) / latStep);
      let col = Math.floor((long - currentLongRange[0]) / longStep);

      row = Math.min(Math.max(row, 0), r - 1);
      col = Math.min(Math.max(col, 0), c - 1);

      return {
        blockNum: row * c + col + 1,
        newLatRange: [
          currentLatRange[0] + row * latStep,
          currentLatRange[0] + (row + 1) * latStep
        ],
        newLongRange: [
          currentLongRange[0] + col * longStep,
          currentLongRange[0] + (col + 1) * longStep
        ]
      };
    }

    function getWords(lat, long) {
      const l1 = getBlock(lat, long, latRange, longRange, rows, cols);
      const word1 = words[(l1.blockNum - 1) % words.length];

      const l2 = getBlock(lat, long, l1.newLatRange, l1.newLongRange, rows, cols);
      const word2 = words[(l2.blockNum - 1) % words.length];

      const l3 = getBlock(lat, long, l2.newLatRange, l2.newLongRange, rows, cols);
      const word3 = words[(l3.blockNum - 1) % words.length];

      const l4 = getBlock(lat, long, l3.newLatRange, l3.newLongRange, 8, 8);
      const word4 = words[(l4.blockNum - 1) % words.length];

      return [word1, word2, word3, word4];
    }

    function showFrom4(lat, long) {
      const result = getWords(lat, long);
      const myFrom4 = result.join("-");
      console.log("Your From4 code:", myFrom4);
    }

    // ✅ Initialize map globally
    const map = L.map('map').setView([28.6139, 77.2090], 5); // New Delhi default
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
    }).addTo(map);

    // ✅ Marker (reusable)
    const marker = L.marker([28.6139, 77.2090]).addTo(map);

    // Remove default zoom
    map.removeControl(map.zoomControl);

    // Add zoom in custom position
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // ✅ Reverse geocoding
    function getAddress(lat, lon) {
      fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
        .then(res => res.json())
        .then(data => {
          console.log("Address:", data.display_name);
          marker.setLatLng([lat, lon]) // move marker
            .bindPopup(data.display_name)
            .openPopup();
        })
        .catch(err => console.error("Error fetching address:", err));
    }

    // ✅ Fetch location + pan map
    function fetchLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            console.log("Coords:", lat, lon);

            // Pan smoothly to new location
            map.panTo([lat, lon]);
            map.setZoom(17);
            // Add marker + address
            getAddress(lat, lon);

            // Show From4 code
            showFrom4(lat, lon);
          },
          () => console.error("Failed to get location.")
        );
      }
    }

    // Expose globally for button onclick
    window.fetchLocation = fetchLocation;

  </script>
</html>
